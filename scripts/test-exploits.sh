#!/usr/bin/env bash
set -euo pipefail

# Run escape attempt tests against a running sandbox server.
# Usage: ./scripts/test-exploits.sh [server_url]

SERVER="${1:-http://localhost:8080}"
PASS=0
FAIL=0

run_test() {
    local name="$1"
    local code="$2"
    local language="$3"
    local expect_fail="$4"

    response=$(curl -s -w "\n%{http_code}" -X POST "${SERVER}/execute" \
        -H "Content-Type: application/json" \
        -d "{\"code\": $(echo "$code" | jq -Rs .), \"language\": \"${language}\", \"timeout\": \"5s\"}")

    http_code=$(echo "$response" | tail -1)
    body=$(echo "$response" | head -n -1)
    exit_code=$(echo "$body" | jq -r '.exit_code // -1')

    if [[ "$expect_fail" == "true" ]]; then
        if [[ "$exit_code" != "0" ]] || [[ "$http_code" != "200" ]]; then
            echo "  PASS: ${name} (blocked)"
            ((PASS++))
        else
            echo "  FAIL: ${name} (should have been blocked)"
            echo "        Output: $(echo "$body" | jq -r '.output' | head -1)"
            ((FAIL++))
        fi
    else
        if [[ "$exit_code" == "0" ]] && [[ "$http_code" == "200" ]]; then
            echo "  PASS: ${name} (succeeded)"
            ((PASS++))
        else
            echo "  FAIL: ${name} (should have succeeded)"
            echo "        Error: $(echo "$body" | jq -r '.stderr' | head -1)"
            ((FAIL++))
        fi
    fi
}

echo "=== Sandbox Security Tests ==="
echo "Target: ${SERVER}"
echo ""

echo "--- Filesystem Escape ---"
run_test "Read /etc/shadow"       "cat /etc/shadow"                     bash true
run_test "Write to root"          "echo pwned > /pwned.txt"             bash true
run_test "Mount filesystem"       "mount /dev/sda1 /mnt"                bash true
run_test "Access Docker socket"   "ls /var/run/docker.sock"             bash true

echo ""
echo "--- Network Escape ---"
run_test "Curl external"          "curl -s http://google.com"           bash true
run_test "Wget external"          "wget -qO- http://google.com"        bash true
run_test "Metadata service"       "curl -s http://169.254.169.254/"    bash true

echo ""
echo "--- Process Escape ---"
run_test "Fork bomb"              ":(){ :|:& };:"                       bash true
run_test "Ptrace"                 "import ctypes; ctypes.CDLL(None).ptrace(0,1,0,0)" python true
run_test "Kernel module"          "insmod /tmp/evil.ko"                 bash true

echo ""
echo "--- Resource Abuse ---"
run_test "Memory bomb"            "x=[]\nwhile True: x.append('A'*1024*1024)" python true
run_test "Disk fill"              "dd if=/dev/zero of=/tmp/big bs=1M count=500" bash true

echo ""
echo "--- Benign (should pass) ---"
run_test "Python hello"           "print('hello')"                      python false
run_test "Node hello"             "console.log('hello')"                node false
run_test "Bash hello"             "echo hello"                          bash false
run_test "Write to /tmp"          "echo ok > /tmp/test && cat /tmp/test" bash false

echo ""
echo "=== Results: ${PASS} passed, ${FAIL} failed ==="

if [[ $FAIL -gt 0 ]]; then
    echo "SECURITY ISSUES DETECTED"
    exit 1
fi
